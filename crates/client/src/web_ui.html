<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>tc</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0a0a;--fg:#c0c0c0;--accent:#00d4aa;--dim:#555;--panel:#111;--border:#222;--red:#ff4444;--yellow:#ccaa00;--green:#00cc66}
body{background:var(--bg);color:var(--fg);font-family:"Courier New",Courier,monospace;font-size:14px;height:100vh;display:flex;flex-direction:column;overflow:hidden}
#status{display:flex;flex-wrap:wrap;gap:8px;align-items:center;padding:8px 12px;border-bottom:1px solid var(--border);background:var(--panel);min-height:36px}
.badge{padding:2px 8px;font-size:12px;font-weight:bold;border-radius:2px}
.badge-conn{background:var(--green);color:#000}
.badge-disconn{background:var(--red);color:#fff}
.badge-recon{background:var(--yellow);color:#000}
.badge-channel{background:var(--accent);color:#000}
.badge-voice{background:var(--green);color:#000}
.badge-muted{background:var(--red);color:#fff}
.badge-speakers{background:#aa44cc;color:#fff}
.badge-users{color:var(--dim);font-size:12px}
.badge-quality{font-size:12px;color:#000}
.badge-name{color:var(--accent);font-size:12px}
#messages{flex:1;overflow-y:auto;padding:8px 12px;font-size:13px;line-height:1.5}
#messages div{white-space:pre-wrap;word-break:break-word}
#buttons{display:flex;gap:6px;padding:6px 12px;border-top:1px solid var(--border);flex-wrap:wrap}
#buttons button{background:var(--panel);color:var(--accent);border:1px solid var(--border);padding:4px 12px;font-family:inherit;font-size:12px;cursor:pointer;border-radius:2px}
#buttons button:hover{background:var(--border);color:#fff}
#input-row{display:flex;padding:8px 12px;gap:8px;border-top:1px solid var(--border)}
#input{flex:1;background:var(--panel);color:var(--fg);border:1px solid var(--border);padding:6px 10px;font-family:inherit;font-size:14px;outline:none;border-radius:2px}
#input:focus{border-color:var(--accent)}
#input::placeholder{color:var(--dim)}
#send-btn{background:var(--accent);color:#000;border:none;padding:6px 16px;font-family:inherit;font-size:14px;cursor:pointer;font-weight:bold;border-radius:2px}
#ws-indicator{position:fixed;bottom:8px;right:12px;width:8px;height:8px;border-radius:50%;background:var(--red)}
#ws-indicator.ok{background:var(--green)}
</style>
</head>
<body>
<div id="status">
  <span class="badge" style="background:cyan;color:#000;font-weight:bold">tc</span>
  <span id="conn-badge" class="badge badge-disconn">DISCONNECTED</span>
  <span id="channel-badge" class="badge badge-channel" hidden></span>
  <span id="voice-badge" class="badge" hidden></span>
  <span id="quality-badge" class="badge badge-quality" hidden></span>
  <span id="speakers-badge" class="badge badge-speakers" hidden></span>
  <span id="users-badge" class="badge badge-users" hidden></span>
  <span id="name-badge" class="badge badge-name" hidden></span>
</div>
<div id="messages"></div>
<div id="buttons">
  <button onclick="send('/create')">/create</button>
  <button onclick="joinPrompt()">/join</button>
  <button onclick="send('/leave')">/leave</button>
  <button onclick="send('/mute')">/mute</button>
  <button onclick="send('/reconnect')">/reconnect</button>
  <button onclick="send('/help')">/help</button>
</div>
<div id="input-row">
  <input id="input" type="text" placeholder="type a command or message..." autocomplete="off">
  <button id="send-btn" onclick="submitInput()">SEND</button>
</div>
<div id="ws-indicator" title="WebSocket disconnected"></div>
<script>
const msgEl=document.getElementById('messages');
const inputEl=document.getElementById('input');
const wsInd=document.getElementById('ws-indicator');
let ws=null;
let lastMsgCount=0;
let history=[];
let histPos=-1;

function connect(){
  const proto=location.protocol==='https:'?'wss:':'ws:';
  ws=new WebSocket(proto+'//'+location.host+'/ws');
  ws.onopen=()=>{wsInd.className='ok';wsInd.title='WebSocket connected'};
  ws.onclose=()=>{wsInd.className='';wsInd.title='WebSocket disconnected';setTimeout(connect,2000)};
  ws.onerror=()=>{ws.close()};
  ws.onmessage=(e)=>{
    try{const state=JSON.parse(e.data);render(state)}catch(err){}
  };
}

function render(s){
  // Connection badge
  const cb=document.getElementById('conn-badge');
  if(s.conn_state==='connected'){cb.textContent='CONNECTED';cb.className='badge badge-conn'}
  else if(s.conn_state==='disconnected'){cb.textContent='DISCONNECTED';cb.className='badge badge-disconn'}
  else{cb.textContent=s.conn_state.toUpperCase();cb.className='badge badge-recon'}

  // Channel
  const chb=document.getElementById('channel-badge');
  if(s.channel){chb.textContent='#'+s.channel;chb.hidden=false}else{chb.hidden=true}

  // Voice/mute
  const vb=document.getElementById('voice-badge');
  if(s.voice_active){
    vb.hidden=false;
    if(s.muted){vb.textContent='MUTED';vb.className='badge badge-muted'}
    else{vb.textContent='VOICE ON';vb.className='badge badge-voice'}
  }else{vb.hidden=true}

  // Quality
  const qb=document.getElementById('quality-badge');
  if(s.voice_quality){
    const[loss,tier]=s.voice_quality;
    qb.textContent=loss+'% loss ('+tier+')';
    qb.style.background=tier==='high'?'var(--green)':tier==='medium'?'var(--yellow)':'var(--red)';
    qb.hidden=false;
  }else{qb.hidden=true}

  // Speakers
  const sb=document.getElementById('speakers-badge');
  if(s.active_speakers&&s.active_speakers.length){sb.textContent=s.active_speakers.join(', ');sb.hidden=false}
  else{sb.hidden=true}

  // Users
  const ub=document.getElementById('users-badge');
  if(s.participants&&s.participants.length){ub.textContent=s.participants.length+' users';ub.hidden=false}
  else{ub.hidden=true}

  // Name
  const nb=document.getElementById('name-badge');
  if(s.name){nb.textContent=s.name;nb.hidden=false}else{nb.hidden=true}

  // Messages â€” incremental append
  if(s.messages){
    if(s.messages.length<lastMsgCount){
      msgEl.innerHTML='';
      lastMsgCount=0;
    }
    for(let i=lastMsgCount;i<s.messages.length;i++){
      const d=document.createElement('div');
      d.textContent=s.messages[i];
      msgEl.appendChild(d);
    }
    lastMsgCount=s.messages.length;
    msgEl.scrollTop=msgEl.scrollHeight;
  }
}

function send(text){
  if(ws&&ws.readyState===1){
    ws.send(JSON.stringify({type:'Command',text:text}));
  }
}

function submitInput(){
  const v=inputEl.value.trim();
  if(!v)return;
  history.push(v);
  histPos=-1;
  send(v);
  inputEl.value='';
  inputEl.focus();
}

function joinPrompt(){
  const id=prompt('Channel ID:');
  if(id&&id.trim())send('/join '+id.trim());
}

inputEl.addEventListener('keydown',(e)=>{
  if(e.key==='Enter'){e.preventDefault();submitInput()}
  else if(e.key==='ArrowUp'){
    e.preventDefault();
    if(history.length){
      if(histPos<0)histPos=history.length;
      if(histPos>0){histPos--;inputEl.value=history[histPos]}
    }
  }else if(e.key==='ArrowDown'){
    e.preventDefault();
    if(histPos>=0){
      histPos++;
      if(histPos>=history.length){histPos=-1;inputEl.value=''}
      else{inputEl.value=history[histPos]}
    }
  }
});

connect();
inputEl.focus();
</script>
</body>
</html>
